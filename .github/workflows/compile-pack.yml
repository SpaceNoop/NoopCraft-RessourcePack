name: Compile and Release Texture Pack

on:
  push:
    branches:
      - main

permissions:
  contents: write

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    # Skip workflow if the commit message starts with "Bump version"
    if: "!startsWith(github.event.head_commit.message, 'Bump version')"

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js for JSON minification
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Get pack version
        id: get_version
        run: |
          VERSION=$(jq -r '.version' pack.mcmeta)
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Current version: $VERSION"

      - name: Update language files
        run: |
          bash lang.devonly/updateLang.sh
          echo "Language files updated from template"

      - name: Prepare build directory
        run: |
          # Create temporary build directory
          mkdir -p build-temp

          # Copy all files except .git
          rsync -av --exclude='.git' --exclude='build-temp' ./ build-temp/

          # Read .compileignore and remove matching files/directories
          if [ -f ".compileignore" ]; then
            while IFS= read -r pattern || [ -n "$pattern" ]; do
              # Skip empty lines and comments
              if [ -z "$pattern" ] || [[ "$pattern" =~ ^[[:space:]]*# ]]; then
                continue
              fi

              echo "Removing pattern: $pattern"

              # Remove matching files/directories
              if [[ "$pattern" == */ ]]; then
                # Directory pattern
                find build-temp -type d -name "${pattern%/}" -exec rm -rf {} + 2>/dev/null || true
              else
                # File or directory pattern (handle both)
                find build-temp -name "$pattern" -exec rm -rf {} + 2>/dev/null || true
              fi
            done < .compileignore
          fi

          echo "Build directory prepared"
          ls -la build-temp/

      - name: Minify JSON and mcmeta files
        run: |
          # Install jq for JSON minification
          sudo apt-get update && sudo apt-get install -y jq

          # Find and minify all .json and .mcmeta files
          find build-temp -type f \( -name "*.json" -o -name "*.mcmeta" \) | while read -r file; do
            echo "Minifying: $file"
            # Create a temporary file for minified content
            jq -c . "$file" > "$file.tmp" && mv "$file.tmp" "$file"
          done

          echo "JSON/mcmeta files minified"

      - name: Create ZIP archive
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          ZIP_NAME="NoopCraft_Pack.zip"

          cd build-temp
          zip -r "../$ZIP_NAME" . -x "*.git*"
          cd ..

          echo "Created ZIP: $ZIP_NAME"
          ls -lh "$ZIP_NAME"
      
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.5.0
        with:
          tag_name: "v${{ steps.get_version.outputs.version }}"
          name: "NoopCraft Pack v${{ steps.get_version.outputs.version }}"
          body: |
            ## NoopCraft Resource Pack v${{ steps.get_version.outputs.version }}

            **Build Information:**
            - Commit: [${{ github.sha }}](https://github.com/SpaceNoop/NoopCraft-RessourcePack/tree/${{ github.sha }})
            - Branch: [${{ github.ref_name }}](https://github.com/SpaceNoop/NoopCraft-RessourcePack/tree/${{ github.ref_name }})
            - Build Date: ${{ github.event.head_commit.timestamp }}

            **Changes:**
            ${{ github.event.head_commit.message }}
          files: NoopCraft_Pack_v*.zip
          draft: false
          prerelease: false
          make_latest: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Bump version
        id: bump_version
        run: |
          VERSION="${{ steps.get_version.outputs.version }}"
          echo "Current version: $VERSION"

          # Parse version components (handle negative versions like 1.0.-1)
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"

          # If patch is negative, set it to 0, otherwise increment it
          if [ "$PATCH" -lt 0 ]; then
            NEW_PATCH=0
          else
            NEW_PATCH=$((PATCH + 1))
          fi

          NEW_VERSION="${MAJOR}.${MINOR}.${NEW_PATCH}"
          echo "New version: $NEW_VERSION"

          # Update pack.mcmeta with new version
          jq --arg version "$NEW_VERSION" '.version = $version' pack.mcmeta > pack.mcmeta.tmp
          mv pack.mcmeta.tmp pack.mcmeta

          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT

      - name: Commit and push version bump
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add pack.mcmeta assets/minecraft/lang/*.json
          git commit -m "Bump version to ${{ steps.bump_version.outputs.new_version }}"
          git push
